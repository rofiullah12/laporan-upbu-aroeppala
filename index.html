<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#0D1B3E">
<title>Laporan Harian ¬∑ UPBU H. Aroeppala Selayar</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0D1B3E; --navy-mid: #1B3A6B; --navy-light: #2E5090;
    --gold: #D4A017; --gold-light: #F0C040;
    --white: #FFFFFF; --gray-50: #F8FAFC; --gray-100: #F1F5F9;
    --gray-200: #E2E8F0; --gray-400: #94A3B8; --gray-600: #475569;
    --gray-800: #1E293B; --green: #10B981; --red: #EF4444;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --radius: 16px; --radius-sm: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--gray-50); color: var(--gray-800); min-height: 100vh; padding-bottom: 40px; }

  .app-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, var(--navy-light) 100%);
    padding: 20px 20px 24px; position: relative; overflow: hidden;
  }
  .app-header::before { content:''; position:absolute; top:-40px; right:-40px; width:180px; height:180px; border-radius:50%; background:rgba(212,160,23,0.12); }
  .header-top { display:flex; align-items:center; gap:12px; }
  .header-logo { width:44px; height:44px; background:rgba(255,255,255,0.15); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.2); flex-shrink:0; }
  .header-title h1 { font-size:15px; font-weight:800; color:var(--white); line-height:1.3; }
  .header-title p { font-size:11px; color:rgba(255,255,255,0.65); margin-top:2px; }
  .header-badge { background:var(--gold); color:var(--navy); font-size:10px; font-weight:700; padding:4px 10px; border-radius:20px; white-space:nowrap; }

  .main { padding: 0 16px; max-width: 540px; margin: 0 auto; }

  .card { background:var(--white); border-radius:var(--radius); padding:20px; margin-top:16px; box-shadow:var(--shadow-sm); border:1px solid var(--gray-100); }
  .card-header { display:flex; align-items:center; gap:12px; margin-bottom:20px; padding-bottom:16px; border-bottom:2px solid var(--gray-100); }
  .card-icon { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
  .card-icon.navy { background:rgba(13,27,62,0.08); }
  .card-icon.gold { background:rgba(212,160,23,0.12); }
  .card-title h2 { font-size:15px; font-weight:700; color:var(--navy); }
  .card-title p { font-size:11px; color:var(--gray-400); margin-top:2px; }

  .form-group { margin-bottom:16px; }
  label { display:block; font-size:12px; font-weight:600; color:var(--gray-600); margin-bottom:6px; letter-spacing:0.3px; text-transform:uppercase; }
  label .required { color:var(--red); margin-left:2px; }
  label .optional { color:var(--gray-400); font-weight:400; text-transform:none; font-size:11px; margin-left:4px; }
  input[type="text"], input[type="date"], textarea, select {
    width:100%; padding:12px 14px; border:1.5px solid var(--gray-200); border-radius:var(--radius-sm);
    font-size:14px; font-family:'Plus Jakarta Sans',sans-serif; color:var(--gray-800);
    background:var(--gray-50); transition:all 0.2s; outline:none; -webkit-appearance:none;
  }
  input:focus, textarea:focus, select:focus { border-color:var(--navy-mid); background:var(--white); box-shadow:0 0 0 3px rgba(27,58,107,0.08); }
  textarea { resize:none; min-height:80px; line-height:1.5; }
  select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:36px; cursor:pointer; }

  .kegiatan-list { display:flex; flex-direction:column; gap:8px; }
  .kegiatan-item { display:flex; gap:8px; align-items:flex-start; }
  .kegiatan-num { width:28px; height:28px; border-radius:8px; background:var(--navy); color:var(--white); font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:10px; }
  .kegiatan-item input { flex:1; }
  .add-kegiatan-btn { width:100%; padding:10px; border:1.5px dashed var(--gray-300); border-radius:var(--radius-sm); background:none; color:var(--navy-mid); font-size:13px; font-weight:600; font-family:'Plus Jakarta Sans',sans-serif; cursor:pointer; transition:all 0.2s; margin-top:8px; display:flex; align-items:center; justify-content:center; gap:6px; }

  .foto-section { margin-top:20px; padding-top:16px; border-top:2px dashed var(--gray-200); }
  .foto-label { font-size:12px; font-weight:600; color:var(--gray-600); letter-spacing:0.3px; text-transform:uppercase; margin-bottom:10px; display:block; }
  .foto-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px; }
  .foto-btn { padding:14px 10px; border-radius:var(--radius-sm); border:1.5px solid var(--gray-200); background:var(--white); cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:6px; transition:all 0.2s; font-family:'Plus Jakarta Sans',sans-serif; }
  .foto-btn:active { transform:scale(0.97); }
  .foto-btn .foto-btn-icon { font-size:24px; }
  .foto-btn .foto-btn-text { font-size:11px; font-weight:600; color:var(--navy); }
  .foto-btn.camera { border-color:var(--navy-mid); background:rgba(27,58,107,0.04); }
  .foto-preview-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:4px; }
  .foto-preview-item { position:relative; aspect-ratio:1; border-radius:10px; overflow:hidden; background:var(--gray-100); border:1.5px solid var(--gray-200); }
  .foto-preview-item img { width:100%; height:100%; object-fit:cover; }
  .foto-remove { position:absolute; top:4px; right:4px; width:20px; height:20px; border-radius:50%; background:rgba(0,0,0,0.6); color:white; border:none; font-size:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .foto-count { font-size:11px; color:var(--gray-400); margin-top:6px; }
  .foto-count span { color:var(--navy); font-weight:600; }
  input[type="file"] { display:none; }

  .sub-section { background:var(--gray-50); border-radius:var(--radius-sm); padding:14px; margin-bottom:12px; border:1px solid var(--gray-200); }
  .sub-section-title { font-size:12px; font-weight:700; color:var(--navy); margin-bottom:10px; display:flex; align-items:center; gap:6px; }

  .btn-submit { width:100%; padding:16px 20px; border-radius:var(--radius-sm); border:none; background:linear-gradient(135deg, var(--green) 0%, #059669 100%); color:var(--white); font-size:15px; font-weight:700; font-family:'Plus Jakarta Sans',sans-serif; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 14px rgba(16,185,129,0.35); margin-top:20px; }
  .btn-submit:active { transform:scale(0.98); }
  .btn-submit:disabled { background:#ccc; box-shadow:none; cursor:not-allowed; }

  .info-box { background:rgba(27,58,107,0.06); border-left:3px solid var(--navy-mid); border-radius:0 var(--radius-sm) var(--radius-sm) 0; padding:10px 14px; font-size:12px; color:var(--navy-mid); margin-bottom:16px; line-height:1.5; }

  /* Unit selector cards */
  .unit-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:4px; }
  .unit-card { padding:14px 10px; border-radius:var(--radius-sm); border:2px solid var(--gray-200); background:var(--white); cursor:pointer; text-align:center; transition:all 0.2s; }
  .unit-card:active { transform:scale(0.97); }
  .unit-card.selected { border-color:var(--navy); background:rgba(13,27,62,0.06); }
  .unit-card .unit-icon { font-size:24px; margin-bottom:4px; }
  .unit-card .unit-name { font-size:12px; font-weight:700; color:var(--navy); }
  .unit-card .unit-sub { font-size:10px; color:var(--gray-400); margin-top:2px; }

  /* Dynamic form section */
  #dynamic-form { display:none; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

  /* Success */
  .success-screen { display:none; text-align:center; padding:40px 20px; }
  .success-screen.show { display:block; animation:slideIn 0.4s ease; }
  .success-icon { width:80px; height:80px; border-radius:50%; background:linear-gradient(135deg,var(--green),#059669); display:flex; align-items:center; justify-content:center; font-size:36px; margin:0 auto 20px; box-shadow:0 8px 24px rgba(16,185,129,0.35); }
  .success-screen h2 { font-size:22px; font-weight:800; color:var(--navy); margin-bottom:8px; }
  .success-screen p { font-size:14px; color:var(--gray-400); line-height:1.6; }
  .success-detail { background:var(--gray-50); border-radius:var(--radius); padding:16px; margin:20px 0; text-align:left; }
  .summary-item { display:flex; padding:8px 0; border-bottom:1px solid var(--gray-100); gap:10px; }
  .summary-item:last-child { border-bottom:none; }
  .summary-key { font-size:12px; color:var(--gray-400); min-width:100px; flex-shrink:0; }
  .summary-val { font-size:13px; color:var(--gray-800); font-weight:500; flex:1; }
  .btn-new { width:100%; padding:15px; border-radius:var(--radius-sm); border:none; background:var(--navy); color:var(--white); font-size:14px; font-weight:700; font-family:'Plus Jakarta Sans',sans-serif; cursor:pointer; margin-top:8px; }

  /* Loading */
  .loading-overlay { display:none; position:fixed; inset:0; background:rgba(13,27,62,0.7); z-index:999; align-items:center; justify-content:center; flex-direction:column; gap:16px; backdrop-filter:blur(4px); }
  .loading-overlay.show { display:flex; }
  .spinner { width:48px; height:48px; border:4px solid rgba(255,255,255,0.2); border-top-color:var(--gold); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { color:var(--white); font-size:14px; font-weight:600; }

  .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--gray-800); color:var(--white); padding:12px 20px; border-radius:999px; font-size:13px; font-weight:500; transition:transform 0.3s ease; z-index:1000; white-space:nowrap; max-width:90vw; text-align:center; }
  .toast.show { transform:translateX(-50%) translateY(0); }
  .toast.error { background:var(--red); }
  .toast.success { background:var(--green); }
</style>
</head>
<body>

<div class="app-header">
  <div class="header-top">
    <div class="header-logo">‚úàÔ∏è</div>
    <div class="header-title">
      <h1>UPBU H. Aroeppala Selayar</h1>
      <p>Laporan Harian Unit Kerja</p>
    </div>
    <div class="header-badge">STAF</div>
  </div>
</div>

<div class="main">

  <!-- FORM UTAMA -->
  <div id="main-form">
    <div class="card">
      <div class="card-header">
        <div class="card-icon navy">üìã</div>
        <div class="card-title">
          <h2>Informasi Pelapor</h2>
          <p>Isi data diri dan pilih unit kerja</p>
        </div>
      </div>

      <div class="info-box">
        Laporan akan dikirim ke <strong>Host/Koordinator</strong> untuk digabungkan. Harap isi sebelum pukul <strong>21.00 WITA</strong>.
      </div>

      <div class="form-group">
        <label>Tanggal Laporan <span class="required">*</span></label>
        <input type="date" id="tanggal">
      </div>
      <div class="form-group">
        <label>Nama Lengkap <span class="required">*</span></label>
        <input type="text" id="nama" placeholder="Nama lengkap sesuai identitas">
      </div>
      <div class="form-group">
        <label>NIP <span class="required">*</span></label>
        <input type="text" id="nip" placeholder="Contoh: 199301012023011001" inputmode="numeric">
      </div>

      <div class="form-group">
        <label>Unit Kerja <span class="required">*</span></label>
        <div class="unit-grid">
          <div class="unit-card" onclick="pilihUnit('PKP-PK', this)">
            <div class="unit-icon">üöí</div>
            <div class="unit-name">PKP-PK</div>
          </div>
          <div class="unit-card" onclick="pilihUnit('Teknisi Listrik', this)">
            <div class="unit-icon">‚ö°</div>
            <div class="unit-name">Teknisi Listrik</div>
            <div class="unit-sub">& Elband</div>
          </div>
          <div class="unit-card" onclick="pilihUnit('Teknisi Bangland', this)">
            <div class="unit-icon">üèóÔ∏è</div>
            <div class="unit-name">Teknisi Bangland</div>
          </div>
          <div class="unit-card" onclick="pilihUnit('Teknisi A2B', this)">
            <div class="unit-icon">üîß</div>
            <div class="unit-name">Teknisi A2B</div>
          </div>
          <div class="unit-card" onclick="pilihUnit('Avsec', this)">
            <div class="unit-icon">üõ°Ô∏è</div>
            <div class="unit-name">Avsec</div>
          </div>
          <div class="unit-card" onclick="pilihUnit('Sanitasi', this)">
            <div class="unit-icon">üßπ</div>
            <div class="unit-name">Sanitasi</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FORM DINAMIS PER UNIT -->
    <div id="dynamic-form">
      <div class="card">
        <div class="card-header">
          <div class="card-icon gold" id="unit-icon-display">üöí</div>
          <div class="card-title">
            <h2 id="unit-title-display">Unit PKP-PK</h2>
            <p>Isi kegiatan hari ini</p>
          </div>
        </div>

        <!-- FORM PKP-PK -->
        <div id="form-pkp" class="unit-form-section" style="display:none">
          <div class="form-group">
            <label>Kegiatan Hari Ini <span class="required">*</span></label>
            <div class="kegiatan-list" id="list-pkp">
              <div class="kegiatan-item">
                <div class="kegiatan-num">1</div>
                <input type="text" placeholder="Contoh: Memanaskan kendaraan operasional">
              </div>
            </div>
            <button class="add-kegiatan-btn" onclick="addKegiatan('pkp')">+ Tambah Kegiatan</button>
          </div>
        </div>

        <!-- FORM TEKNISI LISTRIK -->
        <div id="form-listrik" class="unit-form-section" style="display:none">
          <div class="form-group">
            <label>Kegiatan Teknisi Listrik & Elband <span class="required">*</span></label>
            <div class="kegiatan-list" id="list-listrik">
              <div class="kegiatan-item">
                <div class="kegiatan-num">1</div>
                <input type="text" placeholder="Contoh: Perbaikan lampu PJU jalan masuk">
              </div>
            </div>
            <button class="add-kegiatan-btn" onclick="addKegiatan('listrik')">+ Tambah Kegiatan</button>
          </div>
        </div>

        <!-- FORM TEKNISI BANGLAND -->
        <div id="form-bangland" class="unit-form-section" style="display:none">
          <div class="form-group">
            <label>Kegiatan Teknisi Bangland <span class="required">*</span></label>
            <div class="kegiatan-list" id="list-bangland">
              <div class="kegiatan-item">
                <div class="kegiatan-num">1</div>
                <input type="text" placeholder="Contoh: Pemeliharaan gedung terminal">
              </div>
            </div>
            <button class="add-kegiatan-btn" onclick="addKegiatan('bangland')">+ Tambah Kegiatan</button>
          </div>
        </div>

        <!-- FORM TEKNISI A2B -->
        <div id="form-a2b" class="unit-form-section" style="display:none">
          <div class="form-group">
            <label>Kegiatan Teknisi A2B <span class="required">*</span></label>
            <div class="kegiatan-list" id="list-a2b">
              <div class="kegiatan-item">
                <div class="kegiatan-num">1</div>
                <input type="text" placeholder="Contoh: Perbaikan tangga hidrolik">
              </div>
            </div>
            <button class="add-kegiatan-btn" onclick="addKegiatan('a2b')">+ Tambah Kegiatan</button>
          </div>
        </div>

        <!-- FORM AVSEC -->
        <div id="form-avsec" class="unit-form-section" style="display:none">
          <div class="form-group">
            <label>Kegiatan Avsec <span class="required">*</span></label>
            <div class="kegiatan-list" id="list-avsec">
              <div class="kegiatan-item">
                <div class="kegiatan-num">1</div>
                <input type="text" placeholder="Contoh: Patroli malam">
              </div>
            </div>
            <button class="add-kegiatan-btn" onclick="addKegiatan('avsec')">+ Tambah Kegiatan</button>
          </div>
        </div>

        <!-- FORM SANITASI -->
        <div id="form-sanitasi" class="unit-form-section" style="display:none">
          <div class="form-group">
            <label>Kegiatan Sanitasi <span class="required">*</span></label>
            <div class="kegiatan-list" id="list-sanitasi">
              <div class="kegiatan-item">
                <div class="kegiatan-num">1</div>
                <input type="text" placeholder="Contoh: Membersihkan area terminal">
              </div>
            </div>
            <button class="add-kegiatan-btn" onclick="addKegiatan('sanitasi')">+ Tambah Kegiatan</button>
          </div>
        </div>

        <!-- FOTO (semua unit) -->
        <div class="foto-section">
          <span class="foto-label">üì∑ Dokumentasi Kegiatan <span class="required">*</span></span>
          <div class="foto-actions">
            <button class="foto-btn camera" onclick="document.getElementById('cam-input').click()">
              <span class="foto-btn-icon">üì∏</span>
              <span class="foto-btn-text">Ambil Foto</span>
            </button>
            <button class="foto-btn" onclick="document.getElementById('gal-input').click()">
              <span class="foto-btn-icon">üñºÔ∏è</span>
              <span class="foto-btn-text">Dari Galeri</span>
            </button>
          </div>
          <input type="file" id="cam-input" accept="image/*" capture="environment" multiple onchange="handleFoto(this)">
          <input type="file" id="gal-input" accept="image/*" multiple onchange="handleFoto(this)">
          <div class="foto-preview-grid" id="foto-preview"></div>
          <div class="foto-count">Foto: <span id="foto-cnt">0</span> / 10</div>
        </div>

        <div class="form-group" style="margin-top:20px">
          <label>Catatan Tambahan <span class="optional">(opsional)</span></label>
          <textarea id="catatan" placeholder="Hal-hal khusus yang perlu dilaporkan..."></textarea>
        </div>

        <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:4px">
          <input type="checkbox" id="pernyataan" style="width:18px;height:18px;margin-top:2px;flex-shrink:0;accent-color:var(--navy)">
          <label for="pernyataan" style="text-transform:none;letter-spacing:0;font-size:13px;color:var(--gray-600);font-weight:500">
            Saya menyatakan laporan ini dibuat dengan sebenar-benarnya.
          </label>
        </div>

        <button class="btn-submit" onclick="submitLaporan()" id="btn-submit">
          üöÄ Kirim ke Host
        </button>
      </div>
    </div>
  </div>

  <!-- SUCCESS SCREEN -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">‚úÖ</div>
    <h2>Laporan Terkirim!</h2>
    <p>Laporan kamu sudah diterima oleh Host dan akan digabungkan dengan laporan unit lain.</p>
    <div class="success-detail">
      <div class="summary-item"><span class="summary-key">Tanggal</span><span class="summary-val" id="suc-tanggal">-</span></div>
      <div class="summary-item"><span class="summary-key">Nama</span><span class="summary-val" id="suc-nama">-</span></div>
      <div class="summary-item"><span class="summary-key">Unit</span><span class="summary-val" id="suc-unit">-</span></div>
      <div class="summary-item"><span class="summary-key">Waktu Kirim</span><span class="summary-val" id="suc-waktu">-</span></div>
    </div>
    <p style="font-size:12px;color:var(--gray-400)">Tunggu konfirmasi dari Host bahwa laporan gabungan sudah dikirim ke Kepala Kantor.</p>
    <button class="btn-new" onclick="location.reload()">üìã Isi Laporan Baru</button>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Mengirim laporan...</div>
</div>
<div class="toast" id="toast"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby48cqdvJnU9L7GayK8Gn_jzmSwfv7WH2WrhzAyZaCDuDUsZynZ7b74t5BOs21NOfjyGg/exec";

let selectedUnit = '';
let fotoFiles = [];

const UNIT_CONFIG = {
  'PKP-PK':            { icon:'üöí', form:'pkp',      label:'Unit PKP-PK' },
  'Teknisi Listrik':   { icon:'‚ö°', form:'listrik',   label:'Teknisi Listrik & Elband' },
  'Teknisi Bangland':  { icon:'üèóÔ∏è', form:'bangland',  label:'Teknisi Bangland' },
  'Teknisi A2B':       { icon:'üîß', form:'a2b',       label:'Teknisi A2B' },
  'Avsec':             { icon:'üõ°Ô∏è', form:'avsec',     label:'Unit Avsec' },
  'Sanitasi':          { icon:'üßπ', form:'sanitasi',  label:'Unit Sanitasi' },
};

function pilihUnit(unit, el) {
  // Hapus selected semua
  document.querySelectorAll('.unit-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedUnit = unit;

  // Sembunyikan semua form unit
  document.querySelectorAll('.unit-form-section').forEach(f => f.style.display = 'none');

  // Tampilkan form unit yang dipilih
  const cfg = UNIT_CONFIG[unit];
  document.getElementById(`form-${cfg.form}`).style.display = 'block';
  document.getElementById('unit-icon-display').textContent = cfg.icon;
  document.getElementById('unit-title-display').textContent = cfg.label;

  // Tampilkan form dinamis
  document.getElementById('dynamic-form').style.display = 'block';
  document.getElementById('dynamic-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function addKegiatan(unit) {
  const list = document.getElementById(`list-${unit}`);
  const num = list.children.length + 1;
  const item = document.createElement('div');
  item.className = 'kegiatan-item';
  item.innerHTML = `<div class="kegiatan-num">${num}</div><input type="text" placeholder="Kegiatan ${num}">`;
  list.appendChild(item);
  item.querySelector('input').focus();
}

function getKegiatan(unit) {
  const el = document.getElementById(`list-${unit}`);
  if (!el) return [];
  return Array.from(el.querySelectorAll('input')).map(i => i.value.trim()).filter(v => v);
}

function handleFoto(input) {
  Array.from(input.files).forEach(file => {
    if (fotoFiles.length >= 10) { showToast('Maksimal 10 foto', 'error'); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      resizeImage(e.target.result, 1200, (compressed) => {
        fotoFiles.push({ name: file.name, data: compressed });
        renderPreview();
      });
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function resizeImage(dataUrl, maxWidth, callback) {
  const img = new Image();
  img.onload = () => {
    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
    const canvas = document.createElement('canvas');
    canvas.width = img.width * ratio;
    canvas.height = img.height * ratio;
    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
    callback(canvas.toDataURL('image/jpeg', 0.75));
  };
  img.src = dataUrl;
}

function renderPreview() {
  const grid = document.getElementById('foto-preview');
  grid.innerHTML = '';
  fotoFiles.forEach((foto, i) => {
    const item = document.createElement('div');
    item.className = 'foto-preview-item';
    item.innerHTML = `<img src="${foto.data}"><button class="foto-remove" onclick="removeFoto(${i})">√ó</button>`;
    grid.appendChild(item);
  });
  document.getElementById('foto-cnt').textContent = fotoFiles.length;
}

function removeFoto(idx) {
  fotoFiles.splice(idx, 1);
  renderPreview();
}

async function submitLaporan() {
  const tanggal = document.getElementById('tanggal').value;
  const nama    = document.getElementById('nama').value.trim();
  const nip     = document.getElementById('nip').value.trim();

  if (!tanggal)      { showToast('Pilih tanggal laporan', 'error'); return; }
  if (!nama)         { showToast('Isi nama pelapor', 'error'); return; }
  if (!nip)          { showToast('Isi NIP', 'error'); return; }
  if (!selectedUnit) { showToast('Pilih unit kerja', 'error'); return; }

  const cfg = UNIT_CONFIG[selectedUnit];
  const kegiatan = getKegiatan(cfg.form);
  if (kegiatan.length === 0) { showToast('Isi minimal 1 kegiatan', 'error'); return; }
  if (fotoFiles.length === 0) { showToast('Upload minimal 1 foto dokumentasi', 'error'); return; }
  if (!document.getElementById('pernyataan').checked) { showToast('Centang pernyataan terlebih dahulu', 'error'); return; }

  const tglFormatted = new Date(tanggal + 'T00:00:00').toLocaleDateString('id-ID',
    { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  const payload = {
    type:      'staf',
    tanggal:   tglFormatted,
    nama,
    nip,
    unit:      selectedUnit,
    kegiatan,
    catatan:   document.getElementById('catatan').value.trim(),
    fotos:     fotoFiles.map(f => f.data),
  };

  showLoading('Mengirim laporan ke Host...');

  try {
    if (SCRIPT_URL.includes('GANTI')) {
      await new Promise(r => setTimeout(r, 2000));
    } else {
      await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify(payload) });
    }

    hideLoading();
    document.getElementById('main-form').style.display = 'none';
    document.getElementById('suc-tanggal').textContent = tglFormatted;
    document.getElementById('suc-nama').textContent    = nama;
    document.getElementById('suc-unit').textContent    = selectedUnit;
    document.getElementById('suc-waktu').textContent   = new Date().toLocaleTimeString('id-ID') + ' WITA';
    document.getElementById('successScreen').classList.add('show');
    window.scrollTo({ top:0, behavior:'smooth' });

  } catch(err) {
    hideLoading();
    showToast('Gagal mengirim: ' + err.message, 'error');
  }
}

function showLoading(text) {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

let toastTimer;
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
});
</script>
</body>
</html>
